# uniswap v2 分析

## 一、创建交易对

### 合约地址

在 **Uniswap V2 中新增一个交易对，即创建一个 `Pair` 合约** 的过程，完全可以通过 `logs` 表完成。这个行为发生在 **UniswapV2Factory** 合约中，其核心是调用 `createPair(tokenA, tokenB)` 方法，并产生一个 `PairCreated` 事件。

合约：`UniswapV2Factory`，合约地址（主网）：`0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f`。

这个值将出现在 `address` 字段中。

### 方法签名

方法调用：

```solidity
function createPair(address tokenA, address tokenB) external returns (address pair);
```

事件：

```solidity
event PairCreated(
  address indexed token0,
  address indexed token1,
  address pair,
  uint
);
```

- 这会在 `logs` 表中记录一条 `PairCreated` 事件，用于标记新交易对的创建。

事件签名

```solidity
keccak256("PairCreated(address,address,address,uint256)") = 0x0d3648bd0f6ba80134a33ba9275ac585d9d315f0ad8355cddefde31afa28d0e9
```

这个值将出现在 `topic0` 字段中。

### indexed 参数

按照上面的 Event 的定义，在 `logs` 中，交易币对的位置：

- token0：topic1
- token1：topic2

### 其他参数

- pair：data 前 32 字节为 pair 地址。（占 20 字节，前面补 12 字节零，右对齐）
- index：后 32 字节。

| 参数           | 长度（字节） | 长度（十六进制字符） | 位置范围（字符，1基） | 内容说明                                                     |
| -------------- | ------------ | -------------------- | --------------------- | ------------------------------------------------------------ |
| pair           | 32           | 64                   | 1 — 64                | 前 12 字节（24 字符）是前缀零填充，后 20 字节（40 字符）是真正地址 |
| index(uint256) | 32           | 64                   | 65 — 128              | 64 字符十六进制纯数字                                        |

- **data 不含 `0x`，长度 128 字符**
- **pair 地址占前 64 字符，前 24 字符为 0，后 40 字符是地址**
- **index 紧接其后，占第 65 到 128 字符，全部为有效 uint256 值**

### 总结

| 名称             | 类型    | 位置（数据来源）                          | 位置（`logs` 中）                     | 长度                       | 说明与细节                                                   |
| ---------------- | ------- | ----------------------------------------- | ------------------------------------- | -------------------------- | ------------------------------------------------------------ |
| **合约地址**     | address | 固定地址                                  | `logs.address`                        | 20 字节（40 十六进制字符） | UniswapV2Factory 合约地址，主网：`0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f` |
| **事件签名**     | bytes32 | `对创建交易对方法： PairCreated 进行编码` | `logs.topic0`                         | 32 字节（64 十六进制字符） | 标识 `PairCreated` 事件，值为 `0x0d3648bd0f6ba80134a33ba9275ac585d9d315f0ad8355cddefde31afa28d0e9` |
| **token0**       | address | 事件第 1 个 `indexed` 参数                | `logs.topic1`                         | 32 字节（64 十六进制字符） | 交易对中排序后靠前的代币地址，存储在 topic1，地址右对齐，前面填充零 |
| **token1**       | address | 事件第 2 个 `indexed` 参数                | `logs.topic2`                         | 32 字节（64 十六进制字符） | 交易对中排序后靠后的代币地址，存储在 topic2，地址右对齐，前面填充零 |
| **pair address** | address | 事件非 indexed 第 1 个参数                | `logs.data` 前 32 字节（字符 1-64）   | 32 字节（64 十六进制字符） | 新创建的交易对合约地址，地址占 20 字节（40 字符），前 12 字节（24 字符）为零填充 |
| **index**        | uint256 | 事件非 indexed 第 2 个参数                | `logs.data` 后 32 字节（字符 65-128） | 32 字节（64 十六进制字符） | 新创建交易对的编号，Factory 创建的总 Pair 数量，纯数字，十六进制编码 |

### sql 模版

```sql
with pair_create_logs as (
    select
        block_time
        , tx_hash
        , contract_address as factory_address
        , varbinary_ltrim(topic1) as token0
        , varbinary_ltrim(topic2) as token1
        , varbinary_ltrim (varbinary_substring ("data", 1, 32)) as pair_address
        , varbinary_to_int256 (varbinary_ltrim (varbinary_substring ("data", 33, 64))) as "index"
        from ethereum.logs
        where block_time >= CURRENT_DATE - INTERVAL '9' DAY
        and block_time <= CURRENT_DATE - INTERVAL '2' DAY
   and topic0 = 0x0d3648bd0f6ba80134a33ba9275ac585d9d315f0ad8355cddefde31afa28d0e9
   and contract_address = 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f
        order by
    block_time desc
        limit 100
)
select
    pair_create_logs.*
    , t0.symbol as token0_symbol
    , t1.symbol as token1_symbol
from pair_create_logs
    left join tokens.erc20 t0 on (t0.blockchain = 'ethereum' and t0.contract_address = pair_create_logs.token0)
    left join tokens.erc20 t1 on (t1.blockchain = 'ethereum' and t1.contract_address = pair_create_logs.token1)
```

